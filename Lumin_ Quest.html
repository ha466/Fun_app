<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lumin's Quest</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #0a0a14;
            font-family: 'Press Start 2P', cursive;
            color: #fff;
            overflow: hidden;
        }
        #game-container {
            width: 90vw;
            height: 70vh;
            max-width: 800px;
            max-height: 500px;
            border: 4px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(200, 200, 255, 0.3);
            position: relative;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        canvas { 
            display: block; 
            background: linear-gradient(to bottom, #0c0a1f, #1d1a30);
            image-rendering: pixelated;
        }
        #ui-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            pointer-events: none;
            text-shadow: 2px 2px #000;
        }
        #score-board, #high-score-board {
            font-size: clamp(16px, 3vw, 24px);
        }
        #game-over-screen, #start-screen {
            position: absolute;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(4px);
            text-align: center;
        }
        #game-over-screen h2, #start-screen h1 {
            font-size: clamp(28px, 6vw, 40px);
            margin: 0;
        }
        #start-screen h1 {
            color: #ffff00;
            text-shadow: 3px 3px #a0522d;
        }
        #game-over-screen p, #start-screen p {
            font-size: clamp(14px, 2.5vw, 18px);
            margin: 20px 10px;
            line-height: 1.5;
        }
        #new-highscore-msg {
            color: #ffff00;
            display: none;
        }
        button {
            padding: 12px 28px;
            font-size: clamp(16px, 3vw, 20px);
            background-color: #333;
            color: #fff;
            border: 3px solid #000;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 4px 4px 0 #000;
        }
        button:hover {
            background-color: #ffff00;
            color: #000;
            box-shadow: 2px 2px 0 #000;
        }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>
    <div id="ui-container">
        <div id="score-board">Score: 0</div>
        <div id="high-score-board">High: 0</div>
    </div>

    <div id="start-screen">
        <h1>Lumin's Quest</h1>
        <p>Leap over the encroaching shadows!</p>
        <p>(Press Space or Tap)</p>
        <button id="start-button">Start</button>
    </div>

    <div id="game-over-screen" style="display:none;">
        <h2>Consumed by Shadow...</h2>
        <p id="final-score">Your score: 0</p>
        <p id="new-highscore-msg">New High Score!</p>
        <button id="restart-button">Retry</button>
    </div>
</div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const scoreBoard = document.getElementById('score-board');
const highBoard = document.getElementById('high-score-board');
const startScreen = document.getElementById('start-screen');
const gameOverScreen = document.getElementById('game-over-screen');
const newHighMsg = document.getElementById('new-highscore-msg');
const startButton = document.getElementById('start-button');
const restartButton = document.getElementById('restart-button');
const finalScoreEl = document.getElementById('final-score');

let player, gravity, obstacles, gameSpeed, score, highScore = 0, isGameOver, spawnTimer;
let audioStarted = false;

// Constants
const GROUND_HEIGHT = 30;
const PLAYER_SIZE = 24;
const GRAVITY_FORCE = 0.6;
const JUMP_FORCE = 12;
const START_SPEED = 4;
const SPEED_INCREASE = 0.0015;
const MIN_GAP = 200; // Minimum distance between obstacles
const MAX_GAP = 420;

// Audio setup
const jumpSound = new Tone.Synth({ oscillator: { type: 'square' }}).toDestination();
const scoreSound = new Tone.Synth({ oscillator: { type: 'triangle' }}).toDestination();
const overSound = new Tone.FMSynth().toDestination();
const musicSynth = new Tone.Synth({ oscillator: { type: 'pulse' }, envelope: { attack: 0.05, decay: 0.1, sustain: 0.3, release: 0.3 } }).toDestination();
let musicLoop;

function playJump(){ if(audioStarted) jumpSound.triggerAttackRelease('G5', '8n'); }
function playScore(){ if(audioStarted) scoreSound.triggerAttackRelease('C6', '16n'); }
function playOver(){ if(audioStarted) overSound.triggerAttackRelease('C3', '4n'); }

function resizeCanvas(){ canvas.width = gameContainer.clientWidth; canvas.height = gameContainer.clientHeight; }

class Player {
    constructor(x,y){ this.x=x; this.y=y; this.vy=0; this.grounded=true; }
    draw(){
        ctx.fillStyle='#ffff00';
        ctx.fillRect(this.x,this.y,PLAYER_SIZE,PLAYER_SIZE);
        ctx.fillStyle='#000';
        ctx.fillRect(this.x+14,this.y+6,4,4);
    }
    jump(){ if(this.grounded){ this.vy=-JUMP_FORCE; this.grounded=false; playJump(); } }
    update(){
        this.y += this.vy;
        if(this.y + PLAYER_SIZE < canvas.height - GROUND_HEIGHT){
            this.vy += GRAVITY_FORCE;
        } else {
            this.vy = 0;
            this.y = canvas.height - PLAYER_SIZE - GROUND_HEIGHT;
            this.grounded = true;
        }
        this.draw();
    }
}

class Obstacle {
    constructor(x,y,w,h){ this.x=x; this.y=y; this.w=w; this.h=h; }
    draw(){ ctx.fillStyle='#521212'; ctx.fillRect(this.x,this.y,this.w,this.h); }
    update(speed){ this.x -= speed; this.draw(); }
}

function spawnObstacle(){
    const height = 20 + Math.random()*30;
    const width = 15 + Math.random()*35;
    const y = canvas.height - height - GROUND_HEIGHT;
    obstacles.push(new Obstacle(canvas.width, y, width, height));
}

function drawGround(){
    ctx.fillStyle='#1e1423';
    ctx.fillRect(0, canvas.height - GROUND_HEIGHT, canvas.width, GROUND_HEIGHT);
}

function init(){
    resizeCanvas();
    player = new Player(50, canvas.height - PLAYER_SIZE - GROUND_HEIGHT);
    obstacles = [];
    score = 0;
    gameSpeed = START_SPEED;
    gravity = GRAVITY_FORCE;
    isGameOver = false;
    nextSpawn = 0;
    spawnTimer = 0;

    highScore = localStorage.getItem('luminsQuestHighScore') || 0;
    highBoard.textContent = 'High: ' + highScore;
    scoreBoard.textContent = 'Score: 0';
    gameOverScreen.style.display = 'none';
    startScreen.style.display = 'none';

    if(audioStarted){
        if(musicLoop) musicLoop.stop();
        const melody = ['C3','E3','G3','C4',null,'G3',null];
        musicLoop = new Tone.Sequence((time, note) => {
            if(note) musicSynth.triggerAttackRelease(note, '8n', time);
        }, melody, '4n').start(0);
        Tone.Transport.start();
    }

    requestAnimationFrame(animate);
}

function animate(){
    if(isGameOver) return;
    requestAnimationFrame(animate);
    ctx.clearRect(0,0,canvas.width,canvas.height);
    drawGround();
    player.update();

    // Spawn control
    spawnTimer -= gameSpeed;
    if(spawnTimer <= 0){
        spawnObstacle();
        spawnTimer = MIN_GAP + Math.random()*(MAX_GAP - MIN_GAP);
    }

    for(let i=obstacles.length-1;i>=0;i--){
        const o=obstacles[i];
        o.update(gameSpeed);
        if(o.x + o.w < 0){
            obstacles.splice(i,1);
            score++;
            scoreBoard.textContent='Score: '+score;
            playScore();
        }
        if(player.x < o.x + o.w && player.x + PLAYER_SIZE > o.x && player.y < o.y + o.h && player.y + PLAYER_SIZE > o.y){
            endGame();
        }
    }
    gameSpeed += SPEED_INCREASE;
}

function endGame(){
    isGameOver = true;
    playOver();
    if(musicLoop) musicLoop.stop();
    finalScoreEl.textContent = 'Your score: ' + score;
    if(score > highScore){
        highScore = score;
        localStorage.setItem('luminsQuestHighScore', highScore);
        highBoard.textContent = 'High: ' + highScore;
        newHighMsg.style.display = 'block';
    } else newHighMsg.style.display = 'none';
    gameOverScreen.style.display = 'flex';
}

function userInteraction(){ if(!audioStarted){ Tone.start(); audioStarted=true; } }

document.addEventListener('keydown', e=>{ if(e.code==='Space') player.jump(); });
canvas.addEventListener('mousedown', ()=>player.jump());
canvas.addEventListener('touchstart', ()=>player.jump());
startButton.addEventListener('click', ()=>{ userInteraction(); init(); });
restartButton.addEventListener('click', ()=>{ userInteraction(); init(); });
window.addEventListener('resize', resizeCanvas);
window.onload = ()=>{ resizeCanvas(); highBoard.textContent='High: '+(localStorage.getItem('luminsQuestHighScore')||0); };
</script>

</body>
</html>
